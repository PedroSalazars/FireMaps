<ion-header>
  <ion-toolbar color="primary">
    <ion-title>FireMaps Chiloé</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Mapa -->
  <div class="map-center">
    <div class="map-card">
      <div id="map"></div>
    </div>
  </div>

  <!-- FAB: Reportar -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button color="primary" aria-label="Reportar" (click)="openReportModal()">
      +
    </ion-fab-button>
  </ion-fab>

  <!-- Modal Reportar incidente -->
  <ion-modal [isOpen]="reportOpen" (didDismiss)="closeReportModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Reportar problema</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeReportModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <!-- Ubicación actual y pin movable -->
        <div class="field">
          <div><strong>Ubicación</strong> (máx. 100 m desde tu posición)</div>
          <div class="hint">Se marcó un pin en el mapa. Puedes tocar el mapa para moverlo.</div>
          <div class="hint" *ngIf="reportDistanceM !== null">
            Distancia al GPS: {{ reportDistanceM | number:'1.0-0' }} m
          </div>
        </div>

        <!-- Tipo como botones -->
        <div class="field">
          <div><strong>Tipo</strong></div>
          <div class="types">
            <button class="type-btn" [class.sel]="reportType==='Incendio'" (click)="setReportType('Incendio')">Incendio</button>
            <button class="type-btn" [class.sel]="reportType==='FuGas'" (click)="setReportType('FuGas')">FuGas</button>
            <button class="type-btn" [class.sel]="reportType==='rescate'" (click)="setReportType('rescate')">Rescate</button>
            <button class="type-btn" [class.sel]="reportType==='choque'" (click)="setReportType('choque')">Choque</button>
          </div>
          <div class="hint">La prioridad se ajusta automáticamente según el tipo.</div>
        </div>

        <!-- Dirección autocompletada por reverse -->
        <div class="field">
          <div><strong>Dirección</strong></div>
          <ion-input fill="outline" placeholder="Calculando dirección..." [(ngModel)]="reportAddress"></ion-input>
        </div>

        <!-- Descripción breve -->
        <div class="field">
          <div><strong>Descripción breve</strong> (opcional)</div>
          <ion-textarea fill="outline" [rows]="3" maxlength="240" placeholder="Ej: Humo denso saliendo de vivienda" [(ngModel)]="reportNotes"></ion-textarea>
        </div>

        <!-- Fotos 1-3 -->
        <div class="field">
          <div><strong>Fotos</strong> (1 a 3)</div>
          <input type="file" accept="image/*" multiple (change)="onFilesSelected($event)">
          <div class="hint" *ngIf="selectedFiles.length">Seleccionadas: {{ selectedFiles.length }}</div>
        </div>

        <ion-button expand="block" [disabled]="!canSubmitReport()" (click)="submitReport()">
          Enviar reporte
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <div class="footer-buttons">
      <ion-button fill="outline" [routerLink]="['/vista-inicio']">Inicio</ion-button>
      <ion-button fill="outline" [routerLink]="['/vista-ajustes']">Ajustes</ion-button>
      <ion-button fill="outline" [routerLink]="['/vista-login']">Salir</ion-button>
    </div>
  </ion-toolbar>
</ion-footer>
